$resourceGroup = "rg-dev-01"
$username="azureuser"


#CREATE SUBNET AND VNET
az network vnet create --name vnet01 --resource-group $resourceGroup --address-prefix 10.0.0.0/16 --subnet-name backend-subnet --subnet-prefixes 10.0.0.0/24 --l "East US"


# CREATE LOAD BALANCER RESOURCES
az network public-ip create --resource-group $resourceGroup --name lb-ip --sku Standard --location "East US"
az network lb create --resource-group $resourceGroup --name lb01 --sku Standard --public-ip-address lb-ip --frontend-ip-name frontend01 --backend-pool-name backendpool01


# CREATE 2 AZURE VMS
az vm create --resource-group $resourcegroup --name vm01 --image Win2022Datacenter --admin-username $username --public-ip-address '""' --vnet-name vnet01 --subnet backend-subnet
az vm create --resource-group $resourcegroup --name vm02 --image Win2022Datacenter --admin-username $username --public-ip-address '""' --vnet-name vnet01 --subnet backend-subnet


# INSTALL WEB SERVERS IN THE 2 VMS
az vm run-command invoke -g $resourcegroup -n vm01 --command-id RunPowerShellScript --scripts "Install-WindowsFeature -name Web-Server -IncludeManagementTools"
az vm run-command invoke -g $resourcegroup -n vm02 --command-id RunPowerShellScript --scripts "Install-WindowsFeature -name Web-Server -IncludeManagementTools"


# OPEN PORTS FOR WEB SERVER
az vm open-port --port 80 --resource-group $resourcegroup --name vm01
az vm open-port --port 80 --resource-group $resourcegroup --name vm02


# REMOVE & ADD A NEW HTM FILE THAT DISPLAYS SERVER NAME
az vm run-command invoke -g $resourcegroup -n vm01 --command-id RunPowerShellScript --scripts "Remove-Item  C:\inetpub\wwwroot\iisstart.htm"
az vm run-command invoke -g $resourcegroup -n vm01 --command-id RunPowerShellScript --scripts "Add-Content -Path "C:\inetpub\wwwroot\iisstart.htm" -Value $("Hello World from " + $env:computername)"
az vm run-command invoke -g $resourcegroup -n vm02 --command-id RunPowerShellScript --scripts "Remove-Item  C:\inetpub\wwwroot\iisstart.htm"
az vm run-command invoke -g $resourcegroup -n vm02 --command-id RunPowerShellScript --scripts "Add-Content -Path "C:\inetpub\wwwroot\iisstart.htm" -Value $("Hello World from " + $env:computername)"


# ADD VMS TO THE BACKEND POOL
az network nic ip-config address-pool add --address-pool backendpool01 --ip-config-name ipconfigvm01 --nic-name vm01VMNic --resource-group $resourceGroup --lb-name lb01
az network nic ip-config address-pool add --address-pool backendpool01 --ip-config-name ipconfigvm02 --nic-name vm02VMNic --resource-group $resourceGroup --lb-name lb01